// Sample game data with all custom fields and proper asset paths
const games = [
    {
        id: 1,
        name: "Brian Lara Cricket 21",
        slug: "brian-lara-cricket-21",
        developer: "Game Studioz",
        logo: "logos/blc21.jpg",
        rating: 4.6,
        downloads: "30K+",
        size: "211.65 MB",
        version: "1.0",
        language: "English",
        price: "FREE",
        category: "Sports",
        age: "7+",
        requirements: "ppsspp emulator is required.",
        updatedOn: "Jan 16, 2021",
        featureImage: "screenshots/blc21/featured.jpg",
        description: "Download Brian Lara Cricket 21 For Android PPSSPP Emulator. It's a New MOD patch of Brian Lara Cricket 07 developed by GAME Studioz.<br>1. REALISTIC JERSEYS & BATPACKS - In this Patch you will get Real Jersey of All International Cricket Teams with their sponsors & Real Bats Designed with real Stickers. <br>2. BRIGHT GRAPHICS - you will get HD Graphics Experience in the Game with NO LAG. <br>3. NEW GROUND & PITCH - New realistic Cricket Ground Experience & HD Designed Pitch.<br>4. All New Exciting Crowd with 4,6 and Out Banners.<br> 5. New AdBoards & PitchAds.<br>6. NEW BOUNDARY LINE - Now you will get new 3D boundary line with New Design.<br>7. RENOVATED 3D STADIUMS - Stadiums Are Renovated & Re-textured by the GAME Studioz Team. <br>8. TWO NEW IPL TEAMS - Mumbai Indians and Chennai Super Kings.<br>9. Updated Squads - Now You will Get All New Players.<br>10. Realistic Faces - New Realistic Faces of New Players. ",
        youtubeVideo: "olbXiXzjMG0",
        screenshots: [
            "screenshots/blc21/1.png",
            "screenshots/blc21/featured.jpg",
            "screenshots/blc21/2.jpg",
            "screenshots/blc21/3.jpg",
            "screenshots/blc21/4.jpg"
        ],
        versionHistory: [
            { version: "1.0", date: "Jan 16, 2021", changes: ["initial release."] }
        ],
        fileType: "ZIP File",
        primaryDownloadText: "BLC21 Game",
        alternateDownloadText: "BLC21 Game (Mirror)",
        downloadNote: "1) Download from any one of the link. 2) Extract and run with PPSSPP emulator.",
        isPasswordProtected: false,
        passwordNote: "",
        passwordVideoLink: "",
        primaryDownload: "https://www.mediafire.com/file/68gds7i93wx3lex/Brain_Lara_Cricket_21_By_Game_Studioz.zip/file",
        alternateDownload: "https://www.mediafire.com/file/68gds7i93wx3lex/Brain_Lara_Cricket_21_By_Game_Studioz.zip/file"
    },
    {
        id: 2,
        name: "KBC Champions",
        slug: "kbc-champions",
        developer: "Game Studioz",
        logo: "logos/kbc24.png",
        rating: 4.5,
        downloads: "5K+",
        size: "35.44 MB",
        version: "1.3",
        language: "English",
        price: "FREE",
        category: "Trivia",
        age: "7+",
        requirements: "Android 7.0+ required",
        updatedOn: "Dec 12, 2024",
        featureImage: "screenshots/kbc24/featured.jpg",
        description: "Play the most realistic Kaun Banega Crorepati game based on the hit TV game show! Put your knowledge to the test by answering increasingly difficult trivia questions. Play through hundreds of new questions or real questions that contestants faced on the show. Use your lifelines wisely to climb the money tree and win the grand prize!<br><b>Do you have what it takes to become a CROREPATI?</b><br><b>KBC CHAMPIONS FEATURES:</b><br>1. Play through hundreds of challenging questions modernised for 2024!<br>2. Try Champions Mode to play real questions contestants faced on the show. How well can you do against their scores?<br>3. Use your lifelines to give yourself the best chances of winning. Phone a friend, ask the audience, use a 50:50!<br>4. Compete on the leaderboards to showcase your quizzing skills against other players!<br>5. Experience the original, suspense-building music, and BIG B's Voice from the series!<br>6. Play on the realistic set from the TV show, simulated in 3D! Feel the drama as the pressure builds. Completely ad-free for seamless, uninterrupted gameplay.",
        youtubeVideo: "vNDnseNVx1I",
        screenshots: [
            "screenshots/kbc24/featured.jpg",
            "screenshots/kbc24/2.jpg",
            "screenshots/kbc24/3.jpg",
            "screenshots/kbc24/4.jpg",
            "screenshots/kbc24/5.jpg",
            "screenshots/kbc24/6.jpg",
            "screenshots/kbc24/7.jpg"
        ],
        versionHistory: [
            { version: "1.3", date: "Dec 12, 2024", changes: ["Main Menu UI Overhaul for Enhanced Navigation and Visual Clarity", "Integrated New Store Module (Includes Bikes, Cars, Apartments) with Coin-Based Economy System", "Refined Question Dataset for Improved Accuracy and Engagement", "Performance and Stability Optimizations Across Core Game Modules", "Resolved Minor UI/UX and Functional Bugs"] },
            { version: "1.2", date: "Nov 24, 2024", changes: ["App Expired Error Message Fixed", "Game Platform Changed (Slight Increase in Game Size)", "Splash Screen Removed", "Fixed Critical Memory Leaks", "Question Fixes and Improvements", "Stability Enhancements"] },
            { version: "1.1", date: "Oct 23, 2024", changes: ["Super Sandook: Added 100+ new questions", "110+ New Questions in Hot Seat Mode", "New Studio Graphics in Classic Mode", "If you answer incorrectly, The correct answer of that question is now displayed", "Added SKIP Button for Big B's SuperSawaal Introduction", "Question Fixes and Improvements", "Stability Enhancements"] },
            { version: "1.0", date: "Sep 12, 2024", changes: ["initial release."] }
        ],
        fileType: "APK File",
        primaryDownloadText: "KBC Champions",
        alternateDownloadText: "KBC Champions[mirror]",
        downloadNote: "Download from any one of the link.",
        isPasswordProtected: false,
        passwordNote: "",
        passwordVideoLink: "",
        primaryDownload: "https://www.mediafire.com/file/j7nz1daaammen8i/KBC_Champions_%255B1.3%255D.apk/file",
        alternateDownload: "https://mega.nz/file/PFFEBSpJ#WEyjx8_1Q_ujs3bWV4m6O1INlhld5G01F64Z6hdKCPE"
    },
    {
        id: 3,
        name: "WWE 2K21 MOD SVR11",
        slug: "wwe-2k21-mod-svr11",
        developer: "Game Studioz",
        logo: "logos/2k21.jpg",
        rating: 4.0,
        downloads: "5K+",
        size: "251 MB",
        version: "1.0",
        language: "English",
        price: "FREE",
        category: "Sports",
        age: "10+",
        requirements: "PPSSPP emulator required.",
        updatedOn: "Jan 16, 2021",
        featureImage: "screenshots/2k21/featured.jpg",
        description: "Download WWE 2K21 For Android PPSSPP Emulator. It's a New MOD patch of WWE SVR 11 developed by GAME Studioz & 360 Modding Co.<br><b>GAME FEATURES INFO: </b><br>1 - All New Wrestlers with latest Attires.<br>2 - All New Arenas.<br>3 - Well Designed Arenas.<br>4 - Fixed Universe Mode.<br>5 - Improved Camera Cuts.<br>6 - All New Virtual Crowd.<br>7 - Updated UI.<br>8 - 60 FPS Gameplay.",
        youtubeVideo: "HuonUjcurbg",
        screenshots: [
            "screenshots/2k21/1.jpg",
            "screenshots/2k21/featured.jpg",
            "screenshots/2k21/2.jpg",
            "screenshots/2k21/3.jpg"
        ],
        versionHistory: [
            { version: "1.0", date: "Jan 16, 2021", changes: ["Initial Release."] },
        ],
        fileType: "ZIP File",
        primaryDownloadText: "SVR 11 ISO FILE",
        alternateDownloadText: "WWE 2K21 TEXTURES",
        downloadNote: "1) Download both the game files. 2) Extract and run with PPSSPP emulator",
        isPasswordProtected: true,
        passwordNote: "Password protected archive - Check video for password",
        passwordVideoLink: "https://youtu.be/HuonUjcurbg?feature=shared",
        primaryDownload: "https://www.mediafire.com/file/m1ohmht3txm6854/SVR_11_FOR_WWE_2K21.7z/file",
        alternateDownload: "https://www.mediafire.com/file/v9di653w0jd80bf/WWE_2K21_Textures_Pack_by_Game_Studioz.zip/file"
    },
    {
        id: 4,
        name: "Brian Lara Cricket 20",
        slug: "brian-lara-cricket-20",
        developer: "Game Studioz",
        logo: "logos/blc20.png",
        rating: 4.6,
        downloads: "30K+",
        size: "211 MB",
        version: "1.0",
        language: "English",
        price: "FREE",
        category: "Sports",
        age: "7+",
        requirements: "ppsspp emulator is required.",
        updatedOn: "Jul 8, 2020",
        featureImage: "screenshots/blc20/featured.png",
        description: "Download Brain Lara Cricket 20 For Android PPSSPP Emulator. It's a New MOD patch of Brain Lara Cricket 07 developed by GAME Studioz.<br><b>GAME FEATURES:</b><br>1 - REALISTIC JERSEYS & BATPACKS - In this game you will get Real Jersey of All International Cricket Teams with their sponsors & Real Bats Designed with real Stickers.<br>2 - BRIGHT GRAPHICS - you will get HD Graphics Experience in the Game with NO LAG.<br>3 - NEW GROUND & PITCH - New realistic Cricket Ground Experience & HD Designed Pitch.<br>4 - FIREWORKS - Fireworks After Match winning Celebrations.<br>5 - New AdBoards & PitchAds.<br>6 - NEW BOUNDARY LINE - Now you will get new 3D boundary line with New Design.<br>7 - RENOVATED 3D STADIUMS - Stadiums Are Renovated & Re-textured by the GAME Studioz Team.<br>8 - NEW SCOREBOARD, OVERLAYS & UPDATED UI.<br>9 - NEW STADIUMS - London and Kolkata.<br>10 - Two NEW VIP TEAMS - LegendsXI and AssociateXI & More Surprises!",
        youtubeVideo: "z1P1jbQmP7g",
        screenshots: [
            "screenshots/blc20/1.jpg",
            "screenshots/blc20/featured.png",
            "screenshots/blc20/2.png",
            "screenshots/blc20/3.png",
            "screenshots/blc20/4.png"
        ],
        versionHistory: [
            { version: "1.0", date: "Jul 8, 2020", changes: ["initial release."] }
        ],
        fileType: "ZIP File",
        primaryDownloadText: "BLC20 Game",
        alternateDownloadText: "Speed Fix File",
        downloadNote: "1) Download both the game files. 2) Extract and run with PPSSPP emulator",
        isPasswordProtected: false,
        passwordNote: "",
        passwordVideoLink: "",
        primaryDownload: "https://www.mediafire.com/file/up35n0lyvgnqvub/BRAIN_LARA_CRICKET_20%255BBETA%255D_By_GAME_Studioz.zip/file",
        alternateDownload: "https://www.mediafire.com/file/9lajyuipco54c3d/CRASH_FIX_SET%2528LOW_END_DEVICE%2529.zip/file"
    }
];

let currentGame = null;
let showingAllVersions = false;
let userSelectedRating = 0;

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    renderGames();
    setupScrollAnimations();
    setupRatingInteractions();
    handleRouting(); // Handle initial page load
});

// Fix asset paths based on current URL
function getAssetPath(relativePath) {
    const isOnGamePage = window.location.pathname.startsWith('/games/');
    return isOnGamePage ? `../${relativePath}` : relativePath;
}

// URL Routing Functions
function handleRouting() {
    const currentPath = window.location.pathname;
    
    // Check if URL matches /games/{slug} pattern
    const gameMatch = currentPath.match(/^\/games\/(.+)$/);
    
    if (gameMatch) {
        const gameSlug = gameMatch[1];
        const game = games.find(g => g.slug === gameSlug);
        
        if (game) {
            // Open the game modal directly
            setTimeout(() => {
                openModal(game);
            }, 100);
        } else {
            // Game not found, redirect to home
            navigateToHome();
        }
    }
}

function navigateToGame(game) {
    const newUrl = `/games/${game.slug}`;
    history.pushState({ gameId: game.id }, `${game.name} - GS Store`, newUrl);
    document.title = `${game.name} - GS Store`;
}

function navigateToHome() {
    history.pushState(null, 'GS Store', '/');
    document.title = 'GS Store';
}

// Handle browser back/forward buttons
window.addEventListener('popstate', function(event) {
    if (event.state && event.state.gameId) {
        const game = games.find(g => g.id === event.state.gameId);
        if (game) {
            openModal(game);
        }
    } else {
        closeModal();
    }
});

// Helper function to extract YouTube video ID from various URL formats
function extractYouTubeID(url) {
    if (!url) return null;
    
    // If it's already just an ID, return it
    if (url.length === 11 && !url.includes('/') && !url.includes('=')) {
        return url;
    }
    
    // Handle various YouTube URL formats
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    
    return (match && match[2].length === 11) ? match[1] : null;
}

function renderGames() {
    const gameGrid = document.getElementById('gameGrid');
    gameGrid.innerHTML = '';

    games.forEach((game, index) => {
        const gameCard = createGameCard(game);
        gameCard.style.animationDelay = `${index * 0.1}s`;
        gameCard.classList.add('animate-fadeInUp');
        gameGrid.appendChild(gameCard);
    });
}

function createGameCard(game) {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-lg border border-gray-200 card-hover cursor-pointer p-4 transition-all duration-300 opacity-0';
    card.onclick = () => openModal(game);

    card.innerHTML = `
        <img src="${getAssetPath(game.featureImage)}" alt="${game.name}" class="feature-image">
        <div class="flex items-center space-x-3 mb-3">
            <img src="${getAssetPath(game.logo)}" alt="${game.name} Logo" class="app-logo">
            <div class="flex-1">
                <h4 class="font-semibold text-gray-900 text-sm truncate">${game.name}</h4>
                <p class="text-gray-500 text-xs truncate">${game.developer}</p>
            </div>
        </div>
        <div class="flex items-center justify-between text-xs">
            <div class="flex items-center space-x-1">
                <span class="text-yellow-500">★</span>
                <span class="text-gray-700 font-medium">${game.rating}</span>
            </div>
            <span class="text-gray-500">${game.size}</span>
        </div>
    `;

    // Animate card appearance
    setTimeout(() => {
        card.style.opacity = '1';
    }, 100);

    return card;
}

function generateStars(rating) {
    let stars = '';
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;

    for (let i = 0; i < fullStars; i++) {
        stars += '<i class="fas fa-star"></i>';
    }

    if (hasHalfStar) {
        stars += '<i class="fas fa-star-half-alt"></i>';
    }

    const emptyStars = 5 - Math.ceil(rating);
    for (let i = 0; i < emptyStars; i++) {
        stars += '<i class="far fa-star"></i>';
    }

    return stars;
}

function openModal(game) {
    currentGame = game;
    showingAllVersions = false;
    
    // Update URL and page title
    navigateToGame(game);
    
    // Populate modal content with correct asset paths
    document.getElementById('modalLogo').src = getAssetPath(game.logo);
    document.getElementById('modalLogo').alt = `${game.name} Logo`;
    document.getElementById('modalTitle').textContent = game.name;
    document.getElementById('modalDeveloper').textContent = game.developer;
    document.getElementById('modalRatingNum').textContent = game.rating;
    document.getElementById('modalRating').innerHTML = generateStars(game.rating);
    document.getElementById('modalDownloads').textContent = game.downloads;
    document.getElementById('modalAge').textContent = game.age;
    document.getElementById('modalRequirements').textContent = game.requirements;
    document.getElementById('modalDescription').innerHTML = game.description;
    document.getElementById('modalSize').textContent = game.size;
    document.getElementById('modalSizeDetail').textContent = game.size;
    document.getElementById('modalVersion').textContent = game.version;
    document.getElementById('modalCategory').textContent = game.category;
    document.getElementById('modalDownloadsDetail').textContent = game.downloads;
    document.getElementById('modalLanguage').textContent = game.language;
    document.getElementById('modalPrice').textContent = game.price;
    document.getElementById('modalUpdated').textContent = game.updatedOn;

    // Set game name in feedback form
    document.getElementById('feedbackGameName').value = game.name;

    // Add YouTube video with proper ID extraction
    const videoId = extractYouTubeID(game.youtubeVideo);
    if (videoId) {
        document.getElementById('youtubeVideoSection').style.display = 'block';
        document.getElementById('youtubeVideo').src = `https://www.youtube.com/embed/${videoId}`;
    } else {
        document.getElementById('youtubeVideoSection').style.display = 'none';
    }

    // Add screenshots with correct asset paths
    const screenshotsContainer = document.getElementById('modalScreenshots');
    screenshotsContainer.innerHTML = '';
    game.screenshots.forEach((screenshot, index) => {
        const img = document.createElement('img');
        img.src = getAssetPath(screenshot);
        img.className = 'screenshot-image flex-shrink-0';
        img.alt = `${game.name} Screenshot ${index + 1}`;
        screenshotsContainer.appendChild(img);
    });

    // Populate version history (first 3 items)
    populateVersionHistory();

    document.getElementById('appModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Trigger animations
    setTimeout(() => {
        setupScrollAnimations();
    }, 100);
}

function populateVersionHistory() {
    const versionContainer = document.getElementById('versionHistory');
    const seeMoreBtn = document.getElementById('seeMoreVersions');
    versionContainer.innerHTML = '';

    const versionsToShow = showingAllVersions ? currentGame.versionHistory : currentGame.versionHistory.slice(0, 3);
    
    versionsToShow.forEach((version) => {
        const versionDiv = document.createElement('div');
        versionDiv.className = 'border-l-4 border-black pl-4 pb-4 last:pb-0';
        versionDiv.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <span class="font-semibold text-gray-900">Version ${version.version}</span>
                <span class="text-gray-500 text-sm">${version.date}</span>
            </div>
            <ul class="text-gray-700 text-sm space-y-1">
                ${version.changes.map(change => `<li>• ${change}</li>`).join('')}
            </ul>
        `;
        versionContainer.appendChild(versionDiv);
    });

    // Show/hide "See More" button
    if (currentGame.versionHistory.length > 3) {
        seeMoreBtn.classList.remove('hidden');
        seeMoreBtn.innerHTML = showingAllVersions 
            ? '<i class="fas fa-chevron-up mr-1"></i>Show Less' 
            : '<i class="fas fa-chevron-down mr-1"></i>See More Versions';
    } else {
        seeMoreBtn.classList.add('hidden');
    }
}

function toggleVersionHistory() {
    showingAllVersions = !showingAllVersions;
    populateVersionHistory();
}

function closeModal() {
    document.getElementById('appModal').classList.remove('active');
    document.body.style.overflow = 'auto';
    currentGame = null;
    showingAllVersions = false;
    userSelectedRating = 0;
    resetRatingStars();
    
    // Clear feedback form
    document.getElementById('feedbackGameName').value = '';
    document.getElementById('feedbackName').value = '';
    document.getElementById('feedbackEmail').value = '';
    document.getElementById('feedbackMessage').value = '';
    document.getElementById('feedbackType').selectedIndex = 0;
    
    // Navigate back to home
    navigateToHome();
}

function showDownloadModal() {
    if (!currentGame) return;

    // Update download modal with custom data
    document.getElementById('downloadAppName').textContent = currentGame.name;
    document.getElementById('downloadSize').textContent = currentGame.size;
    document.getElementById('downloadVersion').textContent = `v${currentGame.version}`;
    
    // Update file type
    document.getElementById('downloadFileType').textContent = currentGame.fileType;
    
    // Update download note
    document.getElementById('downloadNote').textContent = currentGame.downloadNote;
    
    // Handle password protection
    const passwordSection = document.getElementById('passwordSection');
    if (currentGame.isPasswordProtected) {
        passwordSection.style.display = 'block';
        document.getElementById('passwordNote').textContent = currentGame.passwordNote;
        document.getElementById('passwordVideoLink').href = currentGame.passwordVideoLink;
    } else {
        passwordSection.style.display = 'none';
    }
    
    // Update button texts
    document.getElementById('primaryDownloadBtn').innerHTML = `
        <i class="fas fa-download"></i>
        <span>${currentGame.primaryDownloadText}</span>
    `;
    
    document.getElementById('alternateDownloadBtn').innerHTML = `
        <i class="fas fa-server"></i>
        <span>${currentGame.alternateDownloadText}</span>
    `;
    
    document.getElementById('downloadModal').classList.add('active');
}

function closeDownloadModal() {
    document.getElementById('downloadModal').classList.remove('active');
}

function handleDownload(type) {
    // Check if user has subscribed in this session
    const isSubscribed = sessionStorage.getItem('gs_store_subscribed') === 'true';
    
    if (!isSubscribed) {
        closeDownloadModal();
        setTimeout(() => showSubscribeModal(), 200);
        return;
    }

    // If subscribed, proceed with actual download
    const downloadUrl = type === 'primary' ? currentGame.primaryDownload : currentGame.alternateDownload;
    
    // Open the download link in a new tab
    window.open(downloadUrl, '_blank');
    
    closeDownloadModal();
}

function showSubscribeModal() {
    document.getElementById('subscribeModal').classList.add('active');
}

function closeSubscribeModal() {
    document.getElementById('subscribeModal').classList.remove('active');
}

function subscribe() {
    // Open YouTube app/channel - REPLACE WITH YOUR ACTUAL CHANNEL URL AND ID
    const youtubeChannelUrl = 'https://www.youtube.com/channel/UCyour-channel-id'; 
    const youtubeAppUrl = 'youtube://channel/UCyour-channel-id'; 
    
    // Save subscription state in session storage
    sessionStorage.setItem('gs_store_subscribed', 'true');
    
    closeSubscribeModal();
    
    // Create a temporary link to open YouTube
    const link = document.createElement('a');
    link.href = youtubeAppUrl;
    link.style.display = 'none';
    document.body.appendChild(link);
    
    try {
        link.click();
        setTimeout(() => {
            window.open(youtubeChannelUrl, '_blank');
        }, 1000);
    } catch (e) {
        window.open(youtubeChannelUrl, '_blank');
    }
    
    document.body.removeChild(link);
    
    setTimeout(() => {
        alert('🎉 Thanks for visiting our YouTube channel! You can now download games.');
        showDownloadModal();
    }, 2000);
}

// Updated sendFeedback function for direct Gmail app integration
function sendFeedback() {
    const gameName = document.getElementById('feedbackGameName').value.trim();
    const userName = document.getElementById('feedbackName').value.trim();
    const userEmail = document.getElementById('feedbackEmail').value.trim();
    const feedbackType = document.getElementById('feedbackType').value;
    const message = document.getElementById('feedbackMessage').value.trim();
    
    // Validation
    if (!userName) {
        alert('Please enter your name!');
        document.getElementById('feedbackName').focus();
        return;
    }
    
    if (!message) {
        alert('Please enter your feedback message!');
        document.getElementById('feedbackMessage').focus();
        return;
    }
    
    // REPLACE WITH YOUR ACTUAL EMAIL ADDRESS
    const developerEmail = 'contact.gamestudioz@gmail.com'; 
    
    // Create email subject
    const subject = `Game Feedback: ${gameName} - ${feedbackType.charAt(0).toUpperCase() + feedbackType.slice(1)}`;
    
    // Create email body with template
    const emailBody = `Hello Game Studioz Team,

I hope this email finds you well. I would like to share my feedback about one of your games.

GAME DETAILS:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Game Name: ${gameName}
Developer: ${currentGame.developer}
Version: ${currentGame.version}
Category: ${currentGame.category}

FEEDBACK DETAILS:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Feedback Type: ${feedbackType.charAt(0).toUpperCase() + feedbackType.slice(1)}
From: ${userName}${userEmail ? ' (' + userEmail + ')' : ''}

MESSAGE:
${message}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Thank you for creating amazing games! Looking forward to your response.

Best regards,
${userName}

---
This feedback was sent via GS Store App
Date: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;

    // Detect device type and use appropriate method
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // Try Gmail app first, then fall back to web Gmail
        const gmailAppUrl = `googlegmail://co?to=${encodeURIComponent(developerEmail)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
        
        // Create invisible link to test Gmail app
        const testLink = document.createElement('a');
        testLink.href = gmailAppUrl;
        testLink.style.display = 'none';
        document.body.appendChild(testLink);
        
        // Try to open Gmail app
        let appOpened = false;
        
        try {
            testLink.click();
            appOpened = true;
            
            // Check if app actually opened (this is a fallback)
            setTimeout(() => {
                if (!document.hidden) {
                    // If page is still visible, app might not have opened
                    // Fall back to web Gmail
                    const webGmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(developerEmail)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
                    window.open(webGmailUrl, '_blank');
                }
            }, 1000);
            
        } catch (error) {
            // Gmail app not available, use web version
            const webGmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(developerEmail)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            window.open(webGmailUrl, '_blank');
        }
        
        document.body.removeChild(testLink);
    } else {
        // Desktop: use web Gmail
        const webGmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(developerEmail)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
        window.open(webGmailUrl, '_blank');
    }
    
    // Success message
    setTimeout(() => {
        alert('📧 Gmail opened with your feedback ready to send! Just tap the Send button.');
        
        // Clear form after successful submission
        document.getElementById('feedbackName').value = '';
        document.getElementById('feedbackEmail').value = '';
        document.getElementById('feedbackMessage').value = '';
        document.getElementById('feedbackType').selectedIndex = 0;
    }, 500);
}

function setupRatingInteractions() {
    const stars = document.querySelectorAll('#userRating .star-interactive');
    const ratingText = document.getElementById('ratingText');
    
    stars.forEach((star, index) => {
        star.addEventListener('mouseenter', () => {
            highlightStars(index + 1);
            updateRatingText(index + 1);
        });
        
        star.addEventListener('click', () => {
            userSelectedRating = index + 1;
            highlightStars(userSelectedRating);
            updateRatingText(userSelectedRating);
        });
    });
    
    document.getElementById('userRating').addEventListener('mouseleave', () => {
        if (userSelectedRating > 0) {
            highlightStars(userSelectedRating);
            updateRatingText(userSelectedRating);
        } else {
            resetRatingStars();
        }
    });
}

function highlightStars(rating) {
    const stars = document.querySelectorAll('#userRating .star-interactive');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
}

function resetRatingStars() {
    const stars = document.querySelectorAll('#userRating .star-interactive');
    stars.forEach(star => {
        star.classList.remove('active');
    });
    document.getElementById('ratingText').textContent = '';
    userSelectedRating = 0;
}

function updateRatingText(rating) {
    const ratingTexts = {
        1: 'Poor',
        2: 'Fair', 
        3: 'Good',
        4: 'Very Good',
        5: 'Excellent'
    };
    document.getElementById('ratingText').textContent = ratingTexts[rating] || '';
}

function submitRating() {
    if (userSelectedRating === 0) {
        alert('Please select a rating first!');
        return;
    }
    
    alert(`🌟 Thank you for rating ${currentGame.name} with ${userSelectedRating} star${userSelectedRating > 1 ? 's' : ''}!`);
    resetRatingStars();
}

function setupScrollAnimations() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
            }
        });
    }, {
        threshold: 0.1,
        rootMargin: '50px'
    });

    document.querySelectorAll('.section-animate').forEach(section => {
        observer.observe(section);
    });
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal') && e.target.classList.contains('fixed')) {
        if (e.target.id === 'downloadModal') closeDownloadModal();
        if (e.target.id === 'subscribeModal') closeSubscribeModal();
    }
});

// Search functionality
document.querySelector('input[type="text"]').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const filteredGames = games.filter(game => 
        game.name.toLowerCase().includes(searchTerm) ||
        game.developer.toLowerCase().includes(searchTerm) ||
        game.category.toLowerCase().includes(searchTerm)
    );
    
    const gameGrid = document.getElementById('gameGrid');
    const existingCards = gameGrid.children;
    Array.from(existingCards).forEach((card, index) => {
        card.style.animationDelay = `${index * 0.02}s`;
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
    });
    
    setTimeout(() => {
        gameGrid.innerHTML = '';
        filteredGames.forEach((game, index) => {
            const gameCard = createGameCard(game);
            gameCard.style.animationDelay = `${index * 0.08}s`;
            gameCard.classList.add('animate-fadeInUp');
            gameGrid.appendChild(gameCard);
        });
    }, 200);
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (document.getElementById('subscribeModal').classList.contains('active')) {
            closeSubscribeModal();
        } else if (document.getElementById('downloadModal').classList.contains('active')) {
            closeDownloadModal();
        } else if (document.getElementById('appModal').classList.contains('active')) {
            closeModal();
        }
    }
});

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        setupRatingInteractions();
    }, 100);
});
